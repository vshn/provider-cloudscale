<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns/website#">
  <head itemscope itemtype="http://schema.org/WebSite">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Crossplane Provider Mechanics :: Cloudscale Provider for Crossplane</title>
    <meta property="og:title" itemprop="name" content="Crossplane Provider Mechanics">
    <meta name="twitter:title" content="Crossplane Provider Mechanics">
    <link rel="canonical" href="https://vshn.github.io/provider-cloudscale/provider-cloudscale/explanations/dev/provider-mechanics.html">
    <meta property="og:url" content="https://vshn.github.io/provider-cloudscale/provider-cloudscale/explanations/dev/provider-mechanics.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Cloudscale Provider for Crossplane" />
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="vshn_ch">
    <meta property="og:locale" content="en_US" />
    <script>var uiRootPath = '../../../../_'</script>
    <script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/7105834.js"></script>
<meta name="apple-mobile-web-app-capable" content="yes" />
<link rel="apple-touch-icon" sizes="152x152" href="/_/img/favicon-152x152.png">
<link rel="apple-touch-icon" sizes="167x167" href="/_/img/favicon-167x167.png">
<link rel="apple-touch-icon" sizes="180x180" href="/_/img/favicon-180x180.png">

<link rel="icon" type="image/png" href="/_/img/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/_/img/favicon-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/_/img/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/_/img/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/_/img/favicon-32x32.png" sizes="32x32">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <div class="vshn_logo"></div>
        <a href="https://vshn.github.io/provider-cloudscale">Cloudscale Provider for Crossplane
           â€“
          v0.3</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">VSHN</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" target="_blank" href="https://www.vshn.ch/">Main website</a>
            <a class="navbar-item" target="_blank" href="https://handbook.vshn.ch/">Handbook</a>
            <a class="navbar-item" target="_blank" href="https://kb.vshn.ch/">Knowledge Base</a>
            <a class="navbar-item" target="_blank" href="https://products.docs.vshn.ch/">Products</a>
            <a class="navbar-item" target="_blank" href="https://legal.docs.vshn.ch/">Legal</a>
            <a class="navbar-item" target="_blank" href="https://control.docs.vshn.ch/">Portal Help</a>
            <a class="navbar-item" target="_blank" href="https://docs.appuio.cloud/">APPUiO Cloud Docs</a>
            <a class="navbar-item" target="_blank" href="https://syn.tools/">Project Syn</a>
            <a class="navbar-item" target="_blank" href="https://k8up.io/">K8up</a>
          </div>
        </div>
        <div class="navbar-item">
          <div class="search-field">
            <input id="search-input" class="search-input" type="search" placeholder="Search">
            <button type="submit" class="search-button">
              <i class="fa fa-search"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="provider-cloudscale" data-version="0.3">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">Cloudscale Provider for Crossplane</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <span class="nav-text"><a href="https://github.com/vshn/provider-cloudscale/releases" target="_blank" rel="noopener">Changelog</a> ðŸ”—</span>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../tutorials/installation.html">Installation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../tutorials/getting-started.html">Getting Started</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">How To</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../how-tos/create-releases.html">Create Releases</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Explanation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">For Developers</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="provider-mechanics.html">Crossplane Provider Mechanics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="objectsuser-reconciliation.html">ObjectsUser Reconciliation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="bucket-reconciliation.html">Bucket Reconciliation</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Cloudscale Provider for Crossplane</span>
    <span class="version">0.3</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../appcat-service-s3/0.1/index.html">AppCat Service S3</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../appcat-service-s3/0.1/index.html">0.1</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../../index.html">Cloudscale Provider for Crossplane</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../index.html">master</a>
        </li>
        <li class="version is-current">
          <a href="../../index.html">0.3</a>
        </li>
        <li class="version">
          <a href="../../../0.2/index.html">0.2</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">Cloudscale Provider for Crossplane</a></li>
    <li>Explanation</li>
    <li>For Developers</li>
    <li><a href="provider-mechanics.html">Crossplane Provider Mechanics</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">0.3</button>
  <div class="version-menu">
    <a class="version" href="../../../explanations/dev/provider-mechanics.html">master</a>
    <a class="version is-current" href="provider-mechanics.html">0.3</a>
    <a class="version is-missing" href="../../../0.2/index.html">0.2</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/vshn/provider-cloudscale/edit/docs/v0.3/docs/modules/ROOT/pages/explanations/dev/provider-mechanics.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Crossplane Provider Mechanics</h1>
<div class="paragraph">
<p>The way a provider has to be implemented is still (as of Crossplane v1.19) rather not obvious.</p>
</div>
<div class="paragraph">
<p>Crossplane does have <a href="https://crossplane.io/docs/v1.9/contributing/provider_development_guide.html">a simple provider development guide</a>.</p>
</div>
<div class="paragraph">
<p>Basically, one has to implement 2 interfaces in Go: <a href="https://pkg.go.dev/github.com/crossplane/crossplane-runtime@v0.17.0/pkg/reconciler/managed#ExternalConnecter">managed.ExternalConnecter</a> and <a href="https://pkg.go.dev/github.com/crossplane/crossplane-runtime@v0.17.0/pkg/reconciler/managed#ExternalClient">managed.ExternalClient</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is some more boilerplate required to set it up correctly, but not relevant in this page.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>managed.ExternalConnecter</code> interface is meant as an entrypoint for every reconciliation.
It&#8217;s the step where the runtime fetches some credentials to connect to an external cloud API.
The return value of <code>ExternalConnector.Connect()</code> is an instance of <code>managed.ExternalClient</code> itself.</p>
</div>
<div class="paragraph">
<p><code>managed.ExternalClient</code> features the 4 basic CRUD methods: <code>Create()</code>, <code>Observe()</code>, <code>Update()</code>, <code>Delete()</code>.
By implementing <code>Connect</code> and these 4 CRUD methods everything should be in place to get started for a managed CRD.</p>
</div>
<div class="paragraph">
<p>What is not comprehensibly explained is how the reconciliation actually works and that can have a significant impact to the implementation.
From the GoDocs it&#8217;s not clear how these methods actually have to be implemented and how they&#8217;re used (how often, in what order).</p>
</div>
<div class="paragraph">
<p>So this is the basic order of the reconciliation performed by <code>crossplane-runtime</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Controller attempts to reconcile the resource (<code>Reconcile()</code> from <code>controller-runtime</code> library)</p>
</li>
<li>
<p>Controller calls <code>Connect()</code> from the managed.ExternalConnecter interface.
Implementers are expected to create some client to interact with the external cloud API.</p>
</li>
<li>
<p>Controller calls Observe() from the <code>managed.ExternalClient</code> interface.
The result determines the next call:</p>
<div class="ulist">
<ul>
<li>
<p>If resource doesn&#8217;t exist, <code>Create()</code> is called.</p>
</li>
<li>
<p>If resource does exist but doesn&#8217;t match desired state, <code>Update()</code> is called.</p>
</li>
<li>
<p>If resource does exist and matches desired state, no method is called anymore.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Controller does another reconciliation (start from top) even if <code>Create()</code> or <code>Update()</code> returned no error.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For deletions, the order is slightly different:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Controller attempts to reconcile the resource (<code>Reconcile()</code> from <code>controller-runtime</code> library)
This is possible thanks to the finalizer that the crossplane runtime manages.</p>
</li>
<li>
<p>Controller calls <code>Connect()</code> from the managed.ExternalConnecter interface.</p>
</li>
<li>
<p>Controller calls Observe() from the <code>managed.ExternalClient</code> interface.
The result determines the next call:</p>
<div class="ulist">
<ul>
<li>
<p>If resource still exists, <code>Delete()</code> is called.</p>
</li>
<li>
<p>If resource doesn&#8217;t exist, no method is called anymore.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Controller does another reconciliation (start from top) even if <code>Delete()</code> returned no error.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>After <code>Create()</code>, <code>Update()</code> and <code>Delete()</code> calls, the controller does another reconciliation of the resource.
This behavior is arguably unnecessary for synchronous operations, but is intended for cases where the cloud API manages resources asynchronously in the background after issuing requests.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Status updates are only allowed from within the <code>Observe()</code> call!
This can make it more difficult in certain scenarios where critical information is only available after immediate creation or update of an external resource.</p>
</div>
</td>
</tr>
</table>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>Copyright Â© VSHN 2021 â€“ All Rights Reserved. <a href="https://vshn.ch/en/privacy-policy/">Privacy Policy</a>, <a href="https://vshn.ch/en/imprint/">Imprint</a>, and <a href="https://vshn.ch/en/contact/">Contact</a>.</p>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
  </body>
</html>
